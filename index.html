import React, { useState, useEffect, useRef } from 'react';
import { RefreshCw, Copy, Smartphone, Globe, MessageSquare, Shield, Activity, ChevronRight, CheckCircle } from 'lucide-react';

// --- CONFIGURATION (HIDDEN FROM UI) ---
const API_KEY = "0e608eeffb571dc5c2757898d52c2777b1d0ed2fa0c9199cafa6e6845e12e366"; 
const API_BASE = "https://api.otprevenue.com/api";
const TELEGRAM_LINK = "https://t.me/AllTypeTricks123";

// --- ICONS ---
const TelegramIcon = () => (
  <svg viewBox="0 0 24 24" className="w-6 h-6 fill-current" xmlns="http://www.w3.org/2000/svg">
    <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-12 12c0 6.627 5.373 12 12 12s12-5.373 12-12S18.571 0 12 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
  </svg>
);

// --- COUNTRY DATA ---
const COUNTRY_CODES = {
  'algeria': 'DZ', 'angola': 'AO', 'benin': 'BJ', 'botswana': 'BW', 'burkina faso': 'BF',
  'burundi': 'BI', 'cameroon': 'CM', 'cape verde': 'CV', 'central african republic': 'CF',
  'chad': 'TD', 'comoros': 'KM', 'congo': 'CG', 'dr congo': 'CD',
  "cote d'ivoire": 'CI', 'ivory coast': 'CI', 'djibouti': 'DJ', 'egypt': 'EG',
  'eritrea': 'ER', 'ethiopia': 'ET', 'gabon': 'GA', 'gambia': 'GM', 'ghana': 'GH',
  'guinea': 'GN', 'kenya': 'KE', 'liberia': 'LR', 'libya': 'LY',
  'madagascar': 'MG', 'malawi': 'MW', 'mali': 'ML', 'mauritius': 'MU', 'morocco': 'MA',
  'mozambique': 'MZ', 'namibia': 'NA', 'niger': 'NE', 'nigeria': 'NG', 'rwanda': 'RW',
  'senegal': 'SN', 'sierra leone': 'SL', 'somalia': 'SO', 'south africa': 'ZA',
  'sudan': 'SD', 'tanzania': 'TZ', 'togo': 'TG', 'tunisia': 'TN', 'uganda': 'UG',
  'zambia': 'ZM', 'zimbabwe': 'ZW',
  'afghanistan': 'AF', 'bangladesh': 'BD', 'cambodia': 'KH', 'china': 'CN',
  'hong kong': 'HK', 'india': 'IN', 'indonesia': 'ID', 'iran': 'IR', 'iraq': 'IQ',
  'israel': 'IL', 'japan': 'JP', 'jordan': 'JO', 'kuwait': 'KW', 'laos': 'LA',
  'lebanon': 'LB', 'malaysia': 'MY', 'mongolia': 'MN', 'myanmar': 'MM',
  'nepal': 'NP', 'oman': 'OM', 'pakistan': 'PK', 'philippines': 'PH',
  'qatar': 'QA', 'saudi arabia': 'SA', 'singapore': 'SG', 'south korea': 'KR',
  'sri lanka': 'LK', 'syria': 'SY', 'taiwan': 'TW', 'thailand': 'TH',
  'turkey': 'TR', 'uae': 'AE', 'united arab emirates': 'AE', 'vietnam': 'VN', 'yemen': 'YE',
  'austria': 'AT', 'belgium': 'BE', 'bulgaria': 'BG', 'croatia': 'HR', 'czech republic': 'CZ',
  'denmark': 'DK', 'estonia': 'EE', 'finland': 'FI', 'france': 'FR', 'germany': 'DE', 'greece': 'GR',
  'hungary': 'HU', 'iceland': 'IS', 'ireland': 'IE', 'italy': 'IT', 'latvia': 'LV',
  'lithuania': 'LT', 'netherlands': 'NL', 'norway': 'NO', 'poland': 'PL', 'portugal': 'PT',
  'romania': 'RO', 'russia': 'RU', 'serbia': 'RS', 'slovakia': 'SK', 'slovenia': 'SI',
  'spain': 'ES', 'sweden': 'SE', 'switzerland': 'CH', 'ukraine': 'UA',
  'uk': 'GB', 'united kingdom': 'GB', 'england': 'GB',
  'argentina': 'AR', 'brazil': 'BR', 'canada': 'CA', 'chile': 'CL', 'colombia': 'CO',
  'cuba': 'CU', 'ecuador': 'EC', 'mexico': 'MX', 'peru': 'PE', 'usa': 'US', 'united states': 'US',
  'uruguay': 'UY', 'venezuela': 'VE',
  'australia': 'AU', 'new zealand': 'NZ', 'fiji': 'FJ', 'papua new guinea': 'PG'
};

const getFlag = (countryName) => {
  if (!countryName) return 'ðŸ³ï¸';
  const code = COUNTRY_CODES[countryName.toLowerCase().trim()];
  if (!code) return 'ðŸ³ï¸';
  return code.toUpperCase().replace(/./g, char => String.fromCodePoint(char.charCodeAt(0) + 127397));
};

export default function App() {
  // State
  const [countries, setCountries] = useState([]);
  const [loadingCountries, setLoadingCountries] = useState(false);
  const [activeNumber, setActiveNumber] = useState(null);
  const [loadingNumber, setLoadingNumber] = useState(false);
  const [otps, setOtps] = useState([]);
  const [polling, setPolling] = useState(true);
  
  const processedOtpIds = useRef(new Set());

  // --- API FUNCTIONS ---

  const fetchCountries = async () => {
    setLoadingCountries(true);
    try {
      const res = await fetch(`${API_BASE}/numbers/available-countries`, {
        method: 'POST',
        headers: { 'X-API-Key': API_KEY, 'Content-Type': 'application/json' },
        body: JSON.stringify({})
      });
      const data = await res.json();
      if (data.success && data.data?.countries) {
        setCountries(data.data.countries);
      }
    } catch (e) {
      console.error("Connection Error", e);
    } finally {
      setLoadingCountries(false);
    }
  };

  const getNumber = async (country) => {
    setLoadingNumber(true);
    try {
      const res = await fetch(`${API_BASE}/numbers/get-number`, {
        method: 'POST',
        headers: { 'X-API-Key': API_KEY, 'Content-Type': 'application/json' },
        body: JSON.stringify({ country })
      });
      const data = await res.json();
      if (data.success && data.data) {
        setActiveNumber({
          ...data.data,
          countryName: country,
        });
      } else {
        alert(`Failed to get number for ${country}. Try again.`);
      }
    } catch (e) {
      alert("Network Error");
    } finally {
      setLoadingNumber(false);
    }
  };

  const changeNumber = async () => {
    if (!activeNumber) return;
    setLoadingNumber(true);
    try {
      const res = await fetch(`${API_BASE}/numbers/change-number`, {
        method: 'POST',
        headers: { 'X-API-Key': API_KEY, 'Content-Type': 'application/json' },
        body: JSON.stringify({ country: activeNumber.countryName })
      });
      const data = await res.json();
      if (data.success && data.data) {
        setActiveNumber({
          ...data.data,
          countryName: activeNumber.countryName,
        });
      }
    } catch (e) {
      console.error(e);
    } finally {
      setLoadingNumber(false);
    }
  };

  // Polling for OTPs (Last 10 matches)
  useEffect(() => {
    if (!polling) return;
    if (countries.length === 0) fetchCountries();

    const fetchOtps = async () => {
      try {
        const res = await fetch(`${API_BASE}/v1/success-numbers?page=1&limit=10`, {
          headers: { 'X-API-Key': API_KEY }
        });
        
        if (res.ok) {
            const data = await res.json();
            const numbers = data.data?.numbers || [];
            
            const newOtps = numbers.map(n => ({
                id: n.id,
                service: n.service,
                number: n.phoneNumber,
                otp: n.otpCode,
                fullMessage: n.fullMessage,
                country: n.country,
                time: n.receivedAt,
            }));

            // We replace the list to keep it fresh with the latest 10 from server
            setOtps(newOtps);
        }
      } catch (e) {
        // Silent fail
      }
    };

    fetchOtps(); // Initial call
    const intervalId = setInterval(fetchOtps, 5000); // Update every 5s

    return () => clearInterval(intervalId);
  }, [polling, countries]);


  // --- UI COMPONENTS ---

  const copyToClipboard = (text) => {
    navigator.clipboard.writeText(text);
  };

  return (
    <div className="min-h-screen bg-black text-green-500 font-mono flex flex-col selection:bg-green-900 selection:text-white">
      
      {/* Header - Minimal & Private */}
      <header className="border-b border-green-800 bg-gray-900 p-4 flex justify-between items-center shadow-[0_0_15px_rgba(0,255,0,0.1)] sticky top-0 z-50">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 bg-green-900 rounded-full flex items-center justify-center border border-green-500 animate-pulse">
            <Shield className="w-6 h-6 text-green-400" />
          </div>
          <div>
            <h1 className="text-2xl font-bold tracking-wider text-white">FB SMS MONSTER</h1>
            <div className="flex items-center gap-2 text-xs text-green-400">
              <span className="relative flex h-2 w-2">
                <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                <span className="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
              </span>
              SECURE CONNECTION
            </div>
          </div>
        </div>
        <button 
             onClick={fetchCountries} 
             className="p-2 hover:bg-green-900 rounded border border-green-800 transition-colors"
             title="Reload"
        >
             <RefreshCw className={`w-5 h-5 ${loadingCountries ? 'animate-spin' : ''}`} />
        </button>
      </header>

      <main className="flex-1 p-4 md:p-6 max-w-5xl mx-auto w-full space-y-8">
        
        {/* SECTION 1: ACTIVE NUMBER & TELEGRAM LINK */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            {/* Active Number Card */}
            <div className="bg-gray-900 border border-green-800 rounded-lg p-6 shadow-lg relative overflow-hidden flex flex-col justify-between">
                {loadingNumber && (
                    <div className="absolute inset-0 bg-black/80 flex items-center justify-center z-10 backdrop-blur-sm">
                        <RefreshCw className="animate-spin w-8 h-8 text-green-500" />
                    </div>
                )}
                
                <div>
                    <h2 className="text-white font-bold mb-4 flex items-center gap-2 border-b border-green-900 pb-2">
                        <Smartphone className="w-5 h-5 text-green-500" />
                        ACTIVE LINE
                    </h2>

                    {activeNumber ? (
                        <div className="space-y-4">
                            <div className="text-center p-4 bg-black rounded border border-green-900">
                                <div className="text-3xl md:text-4xl text-white font-bold tracking-widest mb-1 drop-shadow-[0_0_8px_rgba(74,222,128,0.5)]">
                                    {activeNumber.number}
                                </div>
                                <div className="text-sm text-green-600 flex justify-center items-center gap-2">
                                    {getFlag(activeNumber.countryName)} {activeNumber.countryName.toUpperCase()}
                                </div>
                            </div>
                            
                            <div className="grid grid-cols-2 gap-3">
                                <button 
                                    onClick={() => copyToClipboard(activeNumber.number)}
                                    className="bg-green-900/30 hover:bg-green-900/50 border border-green-700 text-green-400 py-3 rounded flex items-center justify-center gap-2 transition-all font-bold"
                                >
                                    <Copy className="w-4 h-4" /> COPY
                                </button>
                                <button 
                                    onClick={changeNumber}
                                    className="bg-red-900/20 hover:bg-red-900/40 border border-red-900 text-red-400 py-3 rounded flex items-center justify-center gap-2 transition-all font-bold"
                                >
                                    <RefreshCw className="w-4 h-4" /> CHANGE
                                </button>
                            </div>
                        </div>
                    ) : (
                        <div className="text-center py-10 text-gray-500 border-2 border-dashed border-gray-800 rounded bg-black/50">
                            <Smartphone className="w-8 h-8 mx-auto mb-2 opacity-50" />
                            <p>No Number Selected</p>
                            <p className="text-xs mt-1 text-green-700">Select a country to generate</p>
                        </div>
                    )}
                </div>

                {/* TELEGRAM CHANNEL LINK (Requested Feature) */}
                <div className="mt-6 pt-4 border-t border-green-900/50">
                    <p className="text-xs text-center text-gray-400 mb-2">TELEGRAM CHANNEL FOR NUMBERS</p>
                    <a 
                        href={TELEGRAM_LINK} 
                        target="_blank" 
                        rel="noreferrer"
                        className="flex items-center justify-center gap-3 w-full bg-[#229ED9] hover:bg-[#1b8ac0] text-white py-3 rounded-lg shadow-[0_0_15px_rgba(34,158,217,0.4)] transition-all group"
                    >
                        <TelegramIcon />
                        <span className="font-bold tracking-wide group-hover:tracking-wider transition-all">JOIN CHANNEL</span>
                        <ChevronRight className="w-5 h-5 opacity-70" />
                    </a>
                </div>
            </div>

            {/* Country Selector */}
            <div className="bg-gray-900 border border-green-800 rounded-lg p-5 shadow-lg flex flex-col h-[450px]">
                <h2 className="text-white font-bold mb-4 flex items-center gap-2 border-b border-green-900 pb-2">
                    <Globe className="w-5 h-5 text-green-500" />
                    SELECT LOCATION
                </h2>
                
                <div className="flex-1 overflow-y-auto pr-2 custom-scrollbar">
                {countries.length === 0 ? (
                    <div className="text-center text-gray-500 py-20 flex flex-col items-center">
                        {loadingCountries ? (
                            <>
                                <RefreshCw className="animate-spin w-8 h-8 mb-4 text-green-500" />
                                <span>Loading Servers...</span>
                            </>
                        ) : (
                            <span>Waiting for connection...</span>
                        )}
                    </div>
                ) : (
                    <div className="grid grid-cols-2 gap-2">
                        {countries.map((c, idx) => (
                            <button
                                key={idx}
                                onClick={() => getNumber(c.country)}
                                className={`text-left px-3 py-3 rounded flex items-center justify-between group transition-all border ${activeNumber?.countryName === c.country ? 'bg-green-900/40 border-green-500' : 'bg-black border-green-900 hover:border-green-600'}`}
                            >
                                <span className="flex items-center gap-2 text-sm text-gray-300 group-hover:text-white">
                                    <span className="text-lg">{getFlag(c.country)}</span>
                                    <span className="truncate w-24 capitalize font-medium">{c.country}</span>
                                </span>
                                <span className="text-xs bg-green-950 text-green-400 px-2 py-0.5 rounded border border-green-900">
                                    {c.available}
                                </span>
                            </button>
                        ))}
                    </div>
                )}
                </div>
            </div>
        </div>

        {/* SECTION 2: LIVE OTP FEED */}
        <div className="bg-gray-900 border border-green-800 rounded-lg p-6 shadow-lg">
            <div className="flex justify-between items-center mb-6 border-b border-green-900 pb-4">
                <h2 className="text-white font-bold flex items-center gap-3 text-xl">
                    <MessageSquare className="w-6 h-6 text-green-500" />
                    LIVE OTP FEED <span className="text-gray-500 text-sm font-normal ml-2">(Last 10 Matches)</span>
                </h2>
                <div className="flex items-center gap-2 px-3 py-1 bg-black rounded border border-green-900">
                     <span className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                     <span className="text-xs text-green-400 font-bold">LIVE</span>
                </div>
            </div>

            <div className="overflow-hidden rounded-lg border border-green-900 bg-black">
                <table className="w-full text-left text-sm">
                    <thead className="bg-green-900/20 text-green-400 uppercase font-bold text-xs">
                        <tr>
                            <th className="px-4 py-3">Service</th>
                            <th className="px-4 py-3">Number</th>
                            <th className="px-4 py-3">OTP Code</th>
                            <th className="px-4 py-3 text-right">Time</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-green-900/30">
                        {otps.length === 0 ? (
                            <tr>
                                <td colSpan="4" className="px-4 py-10 text-center text-gray-600 italic">
                                    <Activity className="w-8 h-8 mx-auto mb-2 opacity-50" />
                                    Waiting for incoming SMS...
                                </td>
                            </tr>
                        ) : (
                            otps.map((otp, idx) => (
                                <tr key={`${otp.id}-${idx}`} className="hover:bg-green-900/10 transition-colors group">
                                    <td className="px-4 py-3 font-medium text-white flex items-center gap-2">
                                        <span className="w-2 h-2 rounded-full bg-green-500 hidden group-hover:block animate-pulse"></span>
                                        {otp.service}
                                    </td>
                                    <td className="px-4 py-3 text-gray-400 font-mono">
                                        {getFlag(otp.country)} {otp.number}
                                    </td>
                                    <td className="px-4 py-3">
                                        <span 
                                            onClick={() => copyToClipboard(otp.otp)}
                                            className="inline-block bg-green-900/30 text-green-400 px-2 py-1 rounded font-mono font-bold border border-green-800 cursor-pointer hover:bg-green-500 hover:text-black transition-colors"
                                        >
                                            {otp.otp}
                                        </span>
                                    </td>
                                    <td className="px-4 py-3 text-right text-gray-500 text-xs">
                                        {new Date(otp.time).toLocaleTimeString()}
                                    </td>
                                </tr>
                            ))
                        )}
                    </tbody>
                </table>
            </div>
        </div>

      </main>

      <style jsx global>{`
        .custom-scrollbar::-webkit-scrollbar {
          width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
          background: #000; 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
          background: #14532d; 
          border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
          background: #16a34a; 
        }
      `}</style>
    </div>
  );
}


